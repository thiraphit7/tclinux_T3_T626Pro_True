#
# GPON Clone Configuration - HG8145B7N → T626 Pro
# สำหรับ restore config backup
#
# Source: Huawei HG8145B7N-AIS
# Target: T626 Pro (MediaTek)
#
# Usage:
#   1. Copy ไฟล์นี้ไปที่ /etc/gpon_clone.cfg
#   2. รัน: source /etc/gpon_clone.cfg && apply_clone
#

# ========================================
# Device Information (HG8145B7N)
# ========================================
MODEL_NAME="HG8145B7N-AIS"
DEVICE_TYPE="HG8145B7N"
DESCRIPTION="OptiXstar HG8145B7N GPON Terminal (CLASS B+/PRODUCT ID:2150087381LDR7001564)"

# ========================================
# GPON Identifiers
# ========================================

# Serial Number
# Hex: 48575443286F3DB5
# ASCII: HWTC286F3DB5 (Vendor: HWTC, Serial: 286F3DB5)
GPON_SN="HWTC286F3DB5"
GPON_SN_HEX="48575443286F3DB5"
VENDOR_ID="HWTC"
VENDOR_SERIAL="286f3db5"

# LOID (Logical ONU ID)
LOID="8806480495"
LOID_PASSWORD=""

# MAC Address
PON_MAC="E0:AE:A2:EF:B1:CD"

# ========================================
# Hardware/Software Info
# ========================================
HW_VERSION="39E7.A"
SW_VERSION="V5R023C10S104"
SW_SUB_VERSION="1.0"
MANUFACTURE_INFO="2150087381LDR7001564.C402"
EQUIPMENT_ID="HG8145B7N"
CUSTOM_INFO="AIS"

# ========================================
# ONU Settings
# ========================================
ONT_ID="1"
ONU_STATE="O5"

# ========================================
# tcapi Table Names (T626 Pro)
# ========================================
TABLE_GPON_ONU="GPON_ONU"
TABLE_LOID_AUTH="GPON_LOIDAuth"

# ========================================
# Apply Clone Function
# ========================================
apply_clone() {
    echo "=========================================="
    echo "  Clone HG8145B7N → T626 Pro"
    echo "=========================================="
    echo ""

    echo "[1/5] Setting GPON Serial Number..."
    ponmgr gpon set sn ${VENDOR_ID} ${VENDOR_SERIAL}
    tcapi set ${TABLE_GPON_ONU} SerialNumber "${GPON_SN}"
    tcapi set ${TABLE_GPON_ONU} VendorId "${VENDOR_ID}"
    echo "      SN: ${GPON_SN}"

    echo "[2/5] Setting LOID..."
    tcapi set ${TABLE_LOID_AUTH} LOID "${LOID}"
    tcapi set ${TABLE_LOID_AUTH} Password "${LOID_PASSWORD}"
    echo "      LOID: ${LOID}"

    echo "[3/5] Setting Equipment Info..."
    tcapi set ${TABLE_GPON_ONU} EquipmentId "${EQUIPMENT_ID}" 2>/dev/null
    tcapi set ${TABLE_GPON_ONU} HWVersion "${HW_VERSION}" 2>/dev/null
    tcapi set ${TABLE_GPON_ONU} SWVersion "${SW_VERSION}" 2>/dev/null
    echo "      Equipment: ${EQUIPMENT_ID}"

    echo "[4/5] Saving configuration..."
    tcapi commit ${TABLE_GPON_ONU}
    tcapi commit ${TABLE_LOID_AUTH}
    tcapi save
    echo "      Saved!"

    echo "[5/5] Verifying..."
    echo ""
    echo "--- Current Settings ---"
    echo "SN:   $(omcicfgCmd get sn 2>/dev/null | grep -o 'HWTC.*' || echo 'N/A')"
    echo "LOID: $(omcicfgCmd get loid 2>/dev/null | grep -o '[0-9]*' || echo 'N/A')"
    echo ""

    echo "--- ONU Status ---"
    ponmgr gpon get info 2>/dev/null | head -6
    echo ""

    echo "=========================================="
    echo "  Clone Complete!"
    echo "=========================================="
    echo ""
    echo "Expected: ONU State = O5, ONU ID = 1"
    echo ""
}

# ========================================
# Verify Function
# ========================================
verify_clone() {
    echo "=== Verification ==="
    echo ""
    echo "GPON SN:  $(omcicfgCmd get sn 2>/dev/null)"
    echo "LOID:     $(omcicfgCmd get loid 2>/dev/null)"
    echo ""
    ponmgr gpon get info
    echo ""
    echo "PON MAC:  $(ifconfig pon 2>/dev/null | grep -o 'HWaddr.*' || echo 'N/A')"
    echo "PPP IP:   $(ifconfig ppp0 2>/dev/null | grep -o 'inet addr:[0-9.]*' || echo 'Not connected')"
}

# ========================================
# Quick Commands (Copy & Paste)
# ========================================
#
# # Clone ทั้งหมดในคำสั่งเดียว:
# ponmgr gpon set sn HWTC 286f3db5 && \
# tcapi set GPON_ONU SerialNumber "HWTC286F3DB5" && \
# tcapi set GPON_ONU VendorId "HWTC" && \
# tcapi set GPON_LOIDAuth LOID "8806480495" && \
# tcapi set GPON_LOIDAuth Password "" && \
# tcapi commit GPON_ONU && \
# tcapi commit GPON_LOIDAuth && \
# tcapi save && \
# ponmgr gpon get info
#
# ========================================
